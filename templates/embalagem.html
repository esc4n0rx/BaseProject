{% extends "base.html" %}

{% block content %}
<div class="module-header">
    <h1 class="page-title">Embalagem</h1>
    <p class="page-description">Gest√£o de embalagens e materiais</p>
</div>

<div class="module-content">
    <!-- Dashboard de Status -->
    <div class="dashboard-stats-section">
        <h2 class="section-title">Status da Opera√ß√£o</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-info">
                    <div class="stat-value" id="totalRemessas">0</div>
                    <div class="stat-label">Total de Remessas</div>
                </div>
            </div>
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-info">
                    <div class="stat-value" id="pendentes">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
            </div>
            <div class="stat-card processing">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-info">
                    <div class="stat-value" id="emSeparacao">0</div>
                    <div class="stat-label">Em Separa√ß√£o</div>
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <div class="stat-value" id="finalizados">0</div>
                    <div class="stat-label">Finalizados</div>
                </div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <div class="stat-value" id="faturados">0</div>
                    <div class="stat-label">Faturados</div>
                </div>
            </div>
            <div class="stat-card critical">
                <div class="stat-icon">‚úÇÔ∏è</div>
                <div class="stat-info">
                    <div class="stat-value" id="percentualCorte">0%</div>
                    <div class="stat-label">% de Corte</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de A√ß√µes -->
    <div class="actions-section">
        <h2 class="section-title">A√ß√µes Dispon√≠veis</h2>
        <div class="cards-grid">
            <!-- Card Upload de Carga -->
            <div class="action-card" id="uploadCard">
                <div class="card-header">
                    <h3 class="card-title">Upload de Carga</h3>
                    <div class="card-icon">üì§</div>
                </div>
                <div class="card-content">
                    <p class="card-description">
                        Fa√ßa upload de uma planilha Excel com os dados de embalagem para processamento.
                    </p>
                    <div class="card-details">
                        <div class="detail-item">
                            <span class="detail-label">Formato:</span>
                            <span class="detail-value">Excel (.xlsx, .xls)</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tamanho m√°ximo:</span>
                            <span class="detail-value">16MB</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status inicial:</span>
                            <span class="detail-value">Pendente</span>
                        </div>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-primary btn-full" onclick="openUploadModal()">
                        <span class="btn-icon">üì§</span>
                        Fazer Upload
                    </button>
                </div>
            </div>

            <!-- Card Visualizar Dados -->
            <div class="action-card" id="viewDataCard">
                <div class="card-header">
                    <h3 class="card-title">Visualizar Dados</h3>
                    <div class="card-icon">üìä</div>
                </div>
                <div class="card-content">
                    <p class="card-description">
                        Visualize e filtre todos os registros de embalagem cadastrados no sistema.
                    </p>
                    <div class="card-details">
                        <div class="detail-item">
                            <span class="detail-label">Filtros:</span>
                            <span class="detail-value">Data, Status, C√≥digo</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Exporta√ß√£o:</span>
                            <span class="detail-value">Excel, CSV</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pagina√ß√£o:</span>
                            <span class="detail-value">50 registros/p√°gina</span>
                        </div>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-primary btn-full" onclick="openDataModal()">
                        <span class="btn-icon">üìä</span>
                        Visualizar Dados
                    </button>
                </div>
            </div>

            <!-- Card Exportar Dados -->
            <div class="export-card" id="exportCard">
                <div class="card-header">
                    <h3 class="card-title">Exportar Dados</h3>
                    <div class="card-icon">üì•</div>
                </div>
                <div class="card-content" id="exportCardContent">
                    <p class="card-description">
                        Exporte dados de embalagem em formato Excel com filtros personalizados.
                    </p>
                    
                    <!-- Op√ß√µes de Exporta√ß√£o -->
                    <div class="export-options">
                        <div class="export-option">
                            <input type="radio" id="exportAll" name="exportType" value="all" checked>
                            <label for="exportAll">Todos os registros</label>
                        </div>
                        <div class="export-option">
                            <input type="radio" id="exportByRemessa" name="exportType" value="remessa">
                            <label for="exportByRemessa">Por remessa espec√≠fica</label>
                        </div>
                        <div class="export-option">
                            <input type="radio" id="exportByDate" name="exportType" value="date">
                            <label for="exportByDate">Por per√≠odo de datas</label>
                        </div>
                    </div>

                    <!-- Filtros de Exporta√ß√£o -->
                    <div class="export-filters" id="exportFilters">
                        <div class="export-filter-group" id="remessaFilterGroup" style="display: none;">
                            <label for="exportRemessa">Remessa:</label>
                            <input type="text" id="exportRemessa" class="form-input" placeholder="Digite a remessa">
                        </div>
                        <div class="export-filter-group" id="dateStartGroup" style="display: none;">
                            <label for="exportDateStart">Data In√≠cio:</label>
                            <input type="date" id="exportDateStart" class="form-input">
                        </div>
                        <div class="export-filter-group" id="dateEndGroup" style="display: none;">
                            <label for="exportDateEnd">Data Fim:</label>
                            <input type="date" id="exportDateEnd" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Progresso da Exporta√ß√£o -->
                <div class="export-progress" id="exportProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exportProgressFill"></div>
                    </div>
                    <p class="export-progress-text" id="exportProgressText">Preparando exporta√ß√£o...</p>
                </div>

                <!-- Resultado da Exporta√ß√£o -->
                <div class="export-result" id="exportResult">
                    <div class="export-result-icon" id="exportResultIcon"></div>
                    <p class="export-result-message" id="exportResultMessage"></p>
                    <p class="export-result-details" id="exportResultDetails"></p>
                    <button class="btn export-download-btn" id="exportDownloadBtn" style="display: none;">
                        <span class="btn-icon">üì•</span>
                        Download
                    </button>
                </div>

                <div class="card-actions">
                    <button class="btn btn-primary btn-full" id="startExportBtn" onclick="startExport()">
                        <span class="btn-icon">üì•</span>
                        Gerar Exporta√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Upload -->
<div class="modal-overlay" id="uploadModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Upload de Carga</h3>
            <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="upload-section">
                <div class="upload-info">
                    <h4>Instru√ß√µes para Upload</h4>
                    <ul class="upload-instructions">
                        <li>A planilha deve conter as seguintes colunas obrigat√≥rias:</li>
                        <li><strong>Loja, Remessa, Local, Ordem, Posicao_Deposito, Codigo, Descricao_Produto, UM, Qtde_Emb, Qtde_CX, Qtde_UM, Estoque, EAN</strong></li>
                        <li>Formato aceito: .xlsx ou .xls</li>
                        <li>Tamanho m√°ximo: 16MB</li>
                        <li>O sistema ir√° bloquear registros duplicados enviados no mesmo dia</li>
                    </ul>
                </div>
                
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <p class="upload-text">Clique aqui ou arraste um arquivo para fazer upload</p>
                        <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                            Selecionar Arquivo
                        </button>
                    </div>
                    
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="selected-file">
                            <span class="file-icon">üìÑ</span>
                            <span class="file-name" id="fileName"></span>
                            <span class="file-size" id="fileSize"></span>
                            <button type="button" class="remove-file" onclick="removeFile()">&times;</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">Processando arquivo...</p>
            </div>
            
            <div class="upload-result" id="uploadResult" style="display: none;">
                <div class="result-icon" id="resultIcon"></div>
                <h4 class="result-title" id="resultTitle"></h4>
                <p class="result-message" id="resultMessage"></p>
                <div class="result-details" id="resultDetails"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeUploadModal()">Cancelar</button>
            <button class="btn btn-primary" id="uploadButton" onclick="uploadFile()" disabled>
                <span class="btn-icon">üì§</span>
                Fazer Upload
            </button>
        </div>
    </div>
</div>

<!-- Modal de Visualiza√ß√£o de Dados -->
<div class="modal-overlay" id="dataModal">
    <div class="modal-container large-modal">
        <div class="modal-header">
            <h3 class="modal-title">Visualizar Dados de Embalagem</h3>
            <button class="modal-close" onclick="closeDataModal()">&times;</button>
        </div>
        <div class="modal-content">
            <!-- Filtros Avan√ßados -->
            <div class="data-filters-section">
                <h4 class="filters-title">Filtros</h4>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="filterDataInicio">Data In√≠cio:</label>
                        <input type="date" id="filterDataInicio" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label for="filterDataFim">Data Fim:</label>
                        <input type="date" id="filterDataFim" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">Status:</label>
                        <select id="filterStatus" class="form-select">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="em_separacao">Em Separa√ß√£o</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="Faturado">Faturado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterRemessa">Remessa:</label>
                        <input type="text" id="filterRemessa" class="form-input" placeholder="Digite a remessa">
                    </div>
                    <div class="filter-group">
                        <label for="filterLoja">Loja:</label>
                        <input type="text" id="filterLoja" class="form-input" placeholder="Digite a loja">
                    </div>
                    <div class="filter-group">
                        <label for="filterCodigo">C√≥digo:</label>
                        <input type="text" id="filterCodigo" class="form-input" placeholder="Digite o c√≥digo">
                    </div>
                </div>
                <div class="filters-actions">
                    <button class="btn btn-primary btn-sm" onclick="applyDataFilters()">
                        <span class="btn-icon">üîç</span>
                        Aplicar Filtros
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="clearDataFilters()">
                        <span class="btn-icon">üßπ</span>
                        Limpar
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="exportData()">
                        <span class="btn-icon">üì•</span>
                        Exportar
                    </button>
                </div>
            </div>

            <!-- Informa√ß√µes de Resultados -->
           <div class="data-info-section">
                <div class="data-summary">
                    <span class="summary-item">
                        <strong>Total de registros:</strong> 
                        <span id="totalRecords">0</span>
                    </span>
                    <span class="summary-item">
                        <strong>Exibindo:</strong> 
                        <span id="displayedRecords">0</span>
                    </span>
                    <span class="summary-item">
                        <strong>P√°gina:</strong> 
                        <span id="currentPage">1</span> de <span id="totalPages">1</span>
                    </span>
                </div>
            </div>

            <!-- Tabela de Dados -->
             <div class="data-table-section">
                <table class="data-table" id="embalagemTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Loja</th>
                            <th>Remessa</th>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>Qtde Emb</th>
                            <th>Status</th>
                            <th>Data Registro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="embalagemTableBody">
                        <!-- Dados ser√£o carregados via JavaScript -->
                    </tbody>
                </table>

                <!-- Loading State -->
                <div class="table-loading" id="tableLoading" style="display: none;">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="table-empty" id="tableEmpty" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <h4>Nenhum registro encontrado</h4>
                    <p>Tente ajustar os filtros ou fa√ßa upload de novos dados.</p>
                </div>
            </div>

            <!-- Pagina√ß√£o -->
            <div class="pagination-section">
                <div class="pagination-controls">
                    <button class="btn btn-secondary btn-sm" id="prevPageBtn" onclick="previousPage()" disabled>
                        <span class="btn-icon">‚Üê</span>
                        Anterior
                    </button>
                    <div class="page-numbers" id="pageNumbers">
                        <!-- N√∫meros das p√°ginas ser√£o gerados dinamicamente -->
                    </div>
                    <button class="btn btn-secondary btn-sm" id="nextPageBtn" onclick="nextPage()" disabled>
                        Pr√≥xima
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDataModal()">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Registro -->
<div class="modal-overlay" id="recordDetailModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Detalhes do Registro</h3>
            <button class="modal-close" onclick="closeRecordDetailModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="record-details" id="recordDetailsContent">
                <!-- Detalhes ser√£o carregados via JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRecordDetailModal()">Fechar</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/embalagem.js') }}"></script>
{% endblock %}